name: Deploy to Cloud Run
on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    # ğŸ‘‰ ì—¬ê¸°ì„œëŠ” env ì•ˆì—ì„œ env ì°¸ì¡° ê¸ˆì§€! vars.*ë§Œ ì‚¬ìš©í•´ì„œ ì™„ì„±ê°’ì„ ë„£ì–´ì£¼ì„¸ìš”.
    env:
      PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      REGION: ${{ vars.REGION }}
      REPO: ${{ vars.ARTIFACT_REPO }}
      IMAGE_NAME: ${{ vars.IMAGE_NAME }}
      SERVICE_NAME: ${{ vars.SERVICE_NAME }}
      RUNTIME_SA: skylife-runtime@${{ vars.GCP_PROJECT_ID }}.iam.gserviceaccount.com
      GCS_BUCKET: ${{ vars.GCS_BUCKET_NAME }}
      IMAGE_URI: ${{ vars.REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ vars.ARTIFACT_REPO }}/${{ vars.IMAGE_NAME }}

    steps:
      - name: 1) Checkout
        uses: actions/checkout@v4

      # (ì˜µì…˜1) ì„œë¹„ìŠ¤ê³„ì • í‚¤ JSON ì‚¬ìš©
      - name: 2) Auth to Google Cloud (SA JSON)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # (ì˜µì…˜2) WIF ì‚¬ìš© ì‹œ ìœ„ ìŠ¤í… ëŒ€ì‹  ì•„ë˜ ì£¼ì„ í•´ì œ + repository secretsì— GCP_WIF_PROVIDER ë“±ë¡
      # permissions:
      #   id-token: write
      #   contents: read
      # - name: 2) Auth to Google Cloud (WIF)
      #   uses: google-github-actions/auth@v2
      #   with:
      #     workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
      #     service_account: github-deployer@${{ env.PROJECT_ID }}.iam.gserviceaccount.com

      - name: 3) Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: 4) Configure Docker auth (Artifact Registry)
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: 5) Build image
        run: docker build -t $IMAGE_URI:${{ github.sha }} -t $IMAGE_URI:latest .

      - name: 6) Push image
        run: |
          docker push $IMAGE_URI:${{ github.sha }}
          docker push $IMAGE_URI:latest

      - name: 7) Deploy to Cloud Run
        run: |
          gcloud run deploy $SERVICE_NAME \
            --image=$IMAGE_URI:${{ github.sha }} \
            --platform=managed \
            --region=$REGION \
            --allow-unauthenticated \
            --service-account=$RUNTIME_SA \
            --set-env-vars "SPRING_PROFILES_ACTIVE=prod,gcs.bucket-name=$GCS_BUCKET"
